# EmbedPress Development Guide

## Optimized Script Management

This guide explains the optimized build system for EmbedPress frontend development.

## Architecture Overview

```
embedpress/
├── src/                          # React-based components (Vite builds these)
│   ├── Blocks/                   # Gutenberg blocks (React)
│   ├── AdminUI/                  # Admin dashboard (React SPA)
│   ├── Frontend/                 # Frontend analytics & interactions (Vanilla JS)
│   └── Shared/                   # Shared components, hooks, utils
├── EmbedPress/                   # PHP-based components (WordPress handles these)
│   ├── Elementor/                # Elementor widgets (PHP)
│   ├── Shortcode.php             # Shortcodes (PHP)
│   └── ...                       # Other PHP functionality
└── assets/                       # Built files (generated by Vite)
    ├── js/                       # JavaScript builds
    └── css/                      # CSS builds
```

## Build Targets

The build system supports three main targets:

### 1. Blocks (`blocks`)
- **Source**: `src/Blocks/index.js`
- **Output**: `assets/js/blocks.build.js`, `assets/css/blocks.style.build.css`
- **Purpose**: Gutenberg block editor and frontend functionality
- **Dependencies**: WordPress externals (wp.blocks, wp.element, etc.)

### 2. Admin (`admin`)
- **Source**: `src/AdminUI/index.js`
- **Output**: `assets/js/admin.build.js`, `assets/css/admin.build.css`
- **Purpose**: React-based admin dashboard
- **Dependencies**: React, ReactDOM, jQuery

### 3. Frontend (`frontend`)
- **Source**: `src/Frontend/index.js`
- **Output**: `assets/js/frontend.build.js`, `assets/css/frontend.build.css`
- **Purpose**: Frontend analytics, interactions, and enhancements
- **Dependencies**: jQuery (optional)

## Development Commands

### Development Mode (with HMR)
```bash
# Start development for specific target
npm run dev:blocks      # Gutenberg blocks
npm run dev:admin       # Admin dashboard
npm run dev:frontend    # Frontend scripts

# Start development for all targets (default)
npm run dev             # Starts blocks development
```

### Watch Mode (auto-rebuild on changes)
```bash
# Watch specific target
npm run watch:blocks    # Watch blocks only
npm run watch:admin     # Watch admin only
npm run watch:frontend  # Watch frontend only

# Watch all targets simultaneously
npm run watch:all       # Watches all targets
npm start              # Alias for watch:all
```

### Production Build
```bash
# Build specific target
npm run build:blocks    # Build blocks + split CSS
npm run build:admin     # Build admin dashboard
npm run build:frontend  # Build frontend scripts

# Build all targets
npm run build:all       # Builds everything
npm run build          # Alias for build:all
```

## File Organization

### Shared Components (`src/Shared/`)
```
Shared/
├── components/         # Reusable React components
├── hooks/             # Custom React hooks
├── utils/             # Utility functions
├── stores/            # State management (Zustand)
├── services/          # API services
├── types/             # TypeScript types
└── styles/            # SCSS variables and mixins
```

### Path Aliases
The build system includes convenient path aliases:

```javascript
import { Button } from '@components/Button';
import { useAnalytics } from '@hooks/useAnalytics';
import { trackEvent } from '@utils/analytics';
import { useStore } from '@stores/analytics';
```

Available aliases:
- `@` → `src/`
- `@components` → `src/Shared/components`
- `@hooks` → `src/Shared/hooks`
- `@utils` → `src/Shared/utils`
- `@stores` → `src/Shared/stores`
- `@services` → `src/Shared/services`
- `@types` → `src/Shared/types`
- `@assets` → `assets/`
- `@blocks` → `src/Blocks`
- `@admin` → `src/AdminUI`
- `@frontend` → `src/Frontend`

## CSS Management

### SCSS Support
- All targets support SCSS out of the box
- Shared variables are automatically imported: `@import "@/Shared/styles/variables.scss"`
- CSS is automatically split into editor and frontend files for blocks

### CSS Output
- **Blocks**: Automatically split into `blocks.editor.build.css` and `blocks.style.build.css`
- **Admin**: Single file `admin.build.css`
- **Frontend**: Single file `frontend.build.css`

## Best Practices

### 1. Component Organization
```javascript
// ✅ Good: Use shared components
import { Button } from '@components/Button';
import { Modal } from '@components/Modal';

// ❌ Avoid: Duplicating components across targets
```

### 2. State Management
```javascript
// ✅ Good: Use Zustand for global state
import { useAnalyticsStore } from '@stores/analytics';

// ✅ Good: Use React hooks for local state
import { useState, useEffect } from 'react';
```

### 3. Styling
```scss
// ✅ Good: Use shared variables
.my-component {
    color: var(--ep-primary-color);
    padding: $spacing-md;
}

// ✅ Good: Use BEM methodology
.embedpress-block {
    &__header { }
    &__content { }
    &--loading { }
}
```

### 4. TypeScript
```typescript
// ✅ Good: Use proper types
interface AnalyticsEvent {
    type: string;
    data: Record<string, any>;
    timestamp: number;
}

// ✅ Good: Export types for reuse
export type { AnalyticsEvent };
```

## Debugging

### Development Tools
- **Vite Dev Server**: `http://localhost:3000` (when running dev mode)
- **HMR**: Hot module replacement for instant updates
- **Source Maps**: Available in development mode
- **React DevTools**: Works with admin dashboard

### Build Analysis
```bash
# Analyze bundle size
npm run build:admin -- --analyze

# Check for unused dependencies
npm run lint

# Type checking
npm run type-check
```

## Integration with WordPress

### Enqueueing Assets
The PHP side handles asset enqueueing:

```php
// Blocks are enqueued by Gutenberg integration
wp_enqueue_script('embedpress-blocks', EMBEDPRESS_URL_ASSETS . 'js/blocks.build.js');

// Admin is enqueued on admin pages
wp_enqueue_script('embedpress-admin', EMBEDPRESS_URL_ASSETS . 'js/admin.build.js');

// Frontend is enqueued on public pages
wp_enqueue_script('embedpress-frontend', EMBEDPRESS_URL_ASSETS . 'js/frontend.build.js');
```

### WordPress Externals
WordPress dependencies are externalized to avoid bundling:
- `wp.blocks`, `wp.element`, `wp.components`, etc. are loaded from WordPress core
- React and ReactDOM are loaded from WordPress or CDN
- jQuery is loaded from WordPress core

This keeps bundle sizes small and ensures compatibility.

## CSS & JavaScript Asset Management

EmbedPress handles different types of CSS and JavaScript files through multiple strategies:

### 1. Legacy CSS & JS Files

Legacy CSS files (like `embedpress.css`, `plyr.css`) and JS files (like `front.js`, `pdfobject.js`) are handled through:

```bash
# Scan and analyze existing CSS and JS
npm run assets:scan

# Create CSS and JS bundles for different contexts
npm run assets:bundles

# Process third-party CSS and JS
npm run assets:third-party

# Generate comprehensive asset report
npm run assets:report

# Run all asset management tasks
npm run assets:manage

# Legacy commands (still work)
npm run css:scan
npm run css:bundles
npm run css:manage
```

### 2. Third-Party Package CSS & JS

For packages like Optimizely, use the asset loader utility:

```javascript
import { ThirdPartyAssets, assetManager, loadJS, loadCSS } from '@utils/cssLoader';

// Load Optimizely CSS and JS
await ThirdPartyAssets.loadOptimizely();

// Load custom package CSS
await ThirdPartyAssets.loadCustom('my-package-css', '/path/to/package.css');

// Load custom package JS
await loadJS('/path/to/package.js', 'my-package-js');

// Load CSS and JS based on features
await assetManager.loadForFeatures(['ab-testing', 'analytics']);

// Load multiple assets at once
await loadMultipleAssets({
    css: [{ path: '/path/to/styles.css', id: 'custom-styles' }],
    js: [{ path: '/path/to/script.js', id: 'custom-script' }]
});
```

**Option B: Add to Asset Configuration**
```javascript
// In vite.assets.config.js - add to vendor input
vendor: {
    input: {
        // CSS packages
        'optimizely-css': 'node_modules/@optimizely/optimizely-sdk/dist/optimizely.css',

        // JS packages
        'optimizely-js': 'node_modules/@optimizely/optimizely-sdk/dist/optimizely.js',
        'chart-js': 'node_modules/chart.js/dist/chart.min.js'
    }
}
```

### 3. Dynamic CSS Loading in React

Use the `useCSS` hook for feature-based CSS loading:

```javascript
import { useCSS } from '@utils/cssLoader';

const MyComponent = () => {
    const { loading, loaded, error } = useCSS(['custom-player', 'video-embed']);

    if (loading) return <div>Loading styles...</div>;
    if (error) return <div>Error loading styles</div>;

    return <div>Component with loaded styles</div>;
};
```

### 4. CSS Bundles

The system creates optimized bundles for different contexts:

- **Frontend Bundle**: `embedpress.css` + `plyr.css`
- **Admin Bundle**: `admin.css` + `el-icon.css`
- **Elementor Bundle**: `embedpress-elementor.css` + `carousel.min.css`

### 5. Asset Build Configuration

Use the separate asset configuration for processing legacy CSS:

```bash
# Process legacy CSS files
npm run build:assets:legacy

# Process vendor packages
npm run build:assets:vendor

# Create combined bundles
npm run build:assets:bundles

# Build all assets
npm run build:assets:all
```

### 6. CSS Import Strategies

**In React Components:**
```javascript
// ✅ Good: Use CSS loader for conditional loading
import { cssManager } from '@utils/cssLoader';
await cssManager.loadForFeatures(['custom-player']);

// ✅ Good: Import component-specific styles
import './MyComponent.scss';

// ❌ Avoid: Direct imports of large legacy CSS
// import '../../../assets/css/embedpress.css';
```

**In SCSS Files:**
```scss
// ✅ Good: Use shared variables
@import '@/Shared/styles/variables.scss';

// ✅ Good: Import specific utilities
@import '@/Shared/styles/mixins.scss';

// ❌ Avoid: Importing entire legacy stylesheets
// @import '../../../assets/css/embedpress.css';
```

### 7. WordPress Integration

CSS files are enqueued through PHP based on context:

```php
// Legacy CSS (handled by PHP)
wp_enqueue_style('embedpress-style', EMBEDPRESS_URL_ASSETS . 'css/embedpress.css');

// Built CSS (from Vite)
wp_enqueue_style('embedpress-blocks', EMBEDPRESS_URL_ASSETS . 'css/blocks.style.build.css');

// Conditional CSS (loaded dynamically)
// Handled by JavaScript CSS loader
```

### 8. Performance Optimization

- **Preloading**: Use `cssManager.preloadForFeatures()` for critical CSS
- **Lazy Loading**: Load CSS only when features are used
- **Bundling**: Combine related CSS files to reduce HTTP requests
- **Minification**: Automatic minification in production builds

### 9. CSS Dependencies

The CSS manager handles dependencies automatically:

```javascript
// CSS with dependencies will be loaded in correct order
cssManager.cssMap.set('elementor', {
    path: '/assets/css/embedpress-elementor.css',
    dependencies: ['embedpress'], // Will load embedpress.css first
    features: ['elementor-widget']
});
```

### 10. Debugging CSS Issues

```bash
# Generate CSS report to see all files and dependencies
npm run css:report

# Check what CSS is loaded
console.log(cssManager.getLoadedCSS());

# Check if specific CSS is loaded
console.log(cssManager.isLoaded('plyr'));
```
