!function(){"use strict";const e={viewThreshold:49,viewDuration:3e3,viewResetCooldown:6e4,impressionCooldown:5e3,debug:!1,restUrl:embedpress_analytics?.rest_url||"/wp-json/embedpress/v1/analytics/",sessionId:function(){const e="ep_session_id";let t=sessionStorage.getItem(e);return t||(t="ep-"+Date.now()+"-"+Math.random().toString(36).substring(2,10),sessionStorage.setItem(e,t)),t}(),pageUrl:embedpress_analytics?.page_url||window.location.href,postId:embedpress_analytics?.post_id||0,ipLocationData:null},t=new Map,n={viewedContent:new Set,clickedContent:new Set,impressedContent:new Map},i=new IntersectionObserver(i=>{i.forEach(i=>{const o=i.target,r=t.get(o);if(!r)return;let s=Math.floor(100*i.intersectionRatio);if(s<e.viewThreshold&&i.isIntersecting){const t=i.boundingClientRect,n=window.innerHeight,o=window.innerWidth;(Math.min(t.bottom,n)-Math.max(t.top,0))*(Math.min(t.right,o)-Math.max(t.left,0))/(n*o)*100>=30&&(s=Math.max(s,e.viewThreshold))}r.viewportPercentage=s,r.inViewport=i.isIntersecting,i.isIntersecting&&function(t,i){const o=Date.now();o-(n.impressedContent.get(i.contentId)||0)<e.impressionCooldown||(n.impressedContent.set(i.contentId,o),i.lastImpressionTime=o,e.debug&&console.log("📊 Impression:",i.contentId),a({content_id:i.contentId,interaction_type:"impression",interaction_data:{embed_type:i.embedType,embed_url:i.embedUrl,viewport_percentage:i.viewportPercentage,location_data:e.ipLocationData}}))}(0,r),function(t,i,o){if(!i.inViewport||o<e.viewThreshold)return void(i.viewTimer&&(clearTimeout(i.viewTimer),i.viewTimer=null));const r=Date.now();i.viewTracked&&r-(i.lastViewTime||0)>e.viewResetCooldown&&(i.viewTracked=!1),i.viewTracked||n.viewedContent.has(i.contentId)||i.viewTimer||(i.viewTimer=setTimeout(()=>{!function(t,n){e.debug&&console.log("👁️ View:",n.contentId),a({content_id:n.contentId,interaction_type:"view",interaction_data:{embed_type:n.embedType,embed_url:n.embedUrl,viewport_percentage:n.viewportPercentage,view_duration:e.viewDuration}})}(0,i),i.viewTracked=!0,i.lastViewTime=Date.now(),n.viewedContent.add(i.contentId),i.viewTimer=null},e.viewDuration))}(0,r,s)})},{threshold:Array.from({length:11},(e,t)=>t/10)});function o(e){if(t.has(e))return;const n=e.getAttribute("data-embed-type");if(!n)return;let o=e.getAttribute("data-embedpress-content")||e.getAttribute("data-source-id")||e.getAttribute("data-emid")||"ep-"+n+"-"+Math.random().toString(36).substring(2,10);e.setAttribute("data-embedpress-content",o);const a={contentId:o,embedType:n,embedUrl:r(e),inViewport:!1,viewTimer:null,viewTracked:!1,lastImpressionTime:0,lastViewTime:0,viewportPercentage:0};t.set(e,a),i.observe(e)}function r(e){const t=e.querySelector("iframe"),n=e.querySelector("video source"),i=e.querySelector("audio source"),o=e.querySelector("embed"),r=e.querySelector("object");return t?.src||n?.src||i?.src||o?.src||r?.data||e.getAttribute("data-url")||e.getAttribute("data-src")||e.getAttribute("href")||""}function a(t){if(!t.interaction_data?.embed_type||"unknown"===t.interaction_data.embed_type||""===t.interaction_data.embed_type)return void(e.debug&&console.log("⏭️ Skipping tracking for unknown embed type:",t.content_id));const n={...t,session_id:e.sessionId,page_url:e.pageUrl,post_id:e.postId};fetch(e.restUrl+"track",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":embedpress_analytics?.nonce||""},body:JSON.stringify(n),credentials:"same-origin"}).catch(t=>{if(navigator.sendBeacon){const t=new Blob([JSON.stringify(n)],{type:"application/json"});navigator.sendBeacon(e.restUrl+"track",t)}})}function s(){document.querySelectorAll("[data-embed-type]").forEach(o),t.forEach((t,i)=>{i.addEventListener("click",()=>{n.clickedContent.has(t.contentId)||(n.clickedContent.add(t.contentId),e.debug&&console.log("🖱️ Click:",t.contentId),a({content_id:t.contentId,interaction_type:"click",interaction_data:{embed_type:t.embedType,embed_url:t.embedUrl}}))})}),"MutationObserver"in window&&new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&(e.getAttribute?.("data-embed-type")&&o(e),e.querySelectorAll?.("[data-embed-type]").forEach(o))})})}).observe(document.body,{childList:!0,subtree:!0}),function(){const t={session_id:e.sessionId,screen_resolution:window.screen.width+"x"+window.screen.height,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,user_agent:navigator.userAgent};(async function(){try{const t=await fetch("https://ipinfo.io/json"),n=await t.json();e.ipLocationData={country:n.country,city:n.city,timezone:n.timezone,source:"ip"}}catch{return null}})().then(()=>{e.ipLocationData&&(t.country=e.ipLocationData.country,t.city=e.ipLocationData.city),fetch(e.restUrl+"browser-info",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":embedpress_analytics?.nonce||""},body:JSON.stringify(t),credentials:"same-origin"})})}()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()}();